<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç»å…¸è´ªåƒè›‡æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: white;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
        }

        .game-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
        }

        .score-display {
            text-align: right;
        }

        .score-item {
            font-size: 0.9em;
            margin: 2px 0;
        }

        .score-value {
            color: #FFD700;
            font-weight: bold;
        }

        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 5px;
            position: relative;
            min-height: 0;
        }

        #gameCanvas {
            border: 3px solid #FFD700;
            border-radius: 8px;
            background: #000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 95vw;
            max-height: 45vh;
            margin-bottom: 10px;
            touch-action: none; /* ç¦ç”¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
            -webkit-touch-callout: none; /* ç¦ç”¨é•¿æŒ‰èœå• */
            -webkit-user-select: none; /* ç¦ç”¨é€‰æ‹© */
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            width: 100%;
            box-sizing: border-box;
        }

        .game-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .game-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            touch-action: manipulation; /* è§¦æ‘¸ä¼˜åŒ– */
            min-width: 80px;
            -webkit-touch-callout: none; /* ç¦ç”¨é•¿æŒ‰èœå• */
            -webkit-user-select: none; /* ç¦ç”¨é€‰æ‹© */
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .game-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
        }

        .game-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .direction-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 8px;
            max-width: 220px;
            margin: 0 auto;
            min-height: 180px;
        }

        .direction-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation; /* è§¦æ‘¸ä¼˜åŒ– */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 45px;
            -webkit-touch-callout: none; /* ç¦ç”¨é•¿æŒ‰èœå• */
            -webkit-user-select: none; /* ç¦ç”¨é€‰æ‹© */
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .direction-btn:active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            transform: scale(0.95);
        }

        .direction-btn.up { grid-column: 2; grid-row: 1; }
        .direction-btn.left { grid-column: 1; grid-row: 2; }
        .direction-btn.pause { 
            grid-column: 2; 
            grid-row: 2; 
            background: rgba(255, 100, 100, 0.3);
            font-size: 14px;
        }
        .direction-btn.right { grid-column: 3; grid-row: 2; }
        .direction-btn.down { grid-column: 2; grid-row: 3; }

        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .game-over-dialog {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #FFD700;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 90vw;
        }

        .game-over-title {
            font-size: 2em;
            color: #FFD700;
            margin-bottom: 15px;
        }

        .game-over-score {
            font-size: 1.2em;
            margin: 10px 0;
        }

        .new-record {
            color: #FF6B6B;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .restart-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            color: #000;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .restart-btn:active {
            transform: scale(0.95);
        }

        .speed-selector {
            text-align: center;
            margin: 8px 0;
            font-size: 0.8em;
        }

        .speed-selector label {
            margin-right: 8px;
        }

        .speed-selector select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
        }

        .speed-selector option {
            background: #333;
            color: white;
        }
        
        .vibration-selector {
            text-align: center;
            margin: 8px 0;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .vibration-selector label {
            margin-right: 8px;
            color: #87CEEB;
        }
        
        .vibration-selector input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #FFD700;
        }
        
        .vibration-label {
            color: #87CEEB;
            font-size: 0.9em;
        }

        @media (max-width: 480px) {
            .title {
                font-size: 1.2em;
            }
            
            .direction-btn {
                padding: 12px;
                font-size: 18px;
            }
            
            .game-btn {
                padding: 10px 15px;
                font-size: 12px;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .game-header {
                padding: 5px 10px;
            }
            
            .control-panel {
                padding: 10px;
            }
            
            .direction-controls {
                max-width: 150px;
            }
            
            .direction-btn {
                padding: 10px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="game-header">
        <div class="title">ğŸ è´ªåƒè›‡ - ç©¿å¢™ç‰ˆ</div>
        <div class="subtitle">ğŸ’« å¯ä»¥ç©¿è¿‡è¾¹ç•Œä»å¯¹é¢æ»‘å‡º</div>
        <div class="score-display">
            <div class="score-item">åˆ†æ•°: <span class="score-value" id="currentScore">0</span></div>
            <div class="score-item">æœ€é«˜: <span class="score-value" id="highScore">0</span></div>
            <div class="score-item">é•¿åº¦: <span class="score-value" id="snakeLength">1</span></div>
        </div>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div class="control-panel">
        <div class="game-buttons">
            <button class="game-btn" id="startBtn">å¼€å§‹æ¸¸æˆ</button>
            <button class="game-btn" id="resetBtn">é‡æ–°å¼€å§‹</button>
            <button class="game-btn" id="testBtn">æµ‹è¯•æ–¹å‘</button>
        </div>

        <div class="speed-selector">
            <label for="speedSelect">æ¸¸æˆé€Ÿåº¦:</label>
            <select id="speedSelect">
                <option value="200">æ…¢é€Ÿ</option>
                <option value="150" selected>æ­£å¸¸</option>
                <option value="100">å¿«é€Ÿ</option>
                <option value="80">æé€Ÿ</option>
            </select>
        </div>
        
        <div class="vibration-selector">
            <label for="vibrationToggle">æŒ¯åŠ¨åé¦ˆ:</label>
            <input type="checkbox" id="vibrationToggle" checked>
            <span class="vibration-label">å¯ç”¨è§¦è§‰åé¦ˆ</span>
        </div>

        <div class="direction-controls">
            <button class="direction-btn up" data-direction="up">â†‘</button>
            <button class="direction-btn left" data-direction="left">â†</button>
            <button class="direction-btn pause" id="pauseBtn">æš‚åœ</button>
            <button class="direction-btn right" data-direction="right">â†’</button>
            <button class="direction-btn down" data-direction="down">â†“</button>
        </div>
    </div>

    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-dialog">
            <div class="game-over-title">æ¸¸æˆç»“æŸ</div>
            <div class="game-over-score">
                æœ¬æ¬¡åˆ†æ•°: <span id="finalScore">0</span>
            </div>
            <div class="game-over-score">
                è›‡çš„é•¿åº¦: <span id="finalLength">1</span>
            </div>
            <div class="game-over-score" id="recordMessage" style="display: none;">
                <span class="new-record">ğŸ‰ æ–°çºªå½•ï¼ğŸ‰</span>
            </div>
            <button class="restart-btn" id="restartBtn">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        class AndroidSnakeGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // è‡ªé€‚åº”ç”»å¸ƒå¤§å°
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resizeCanvas(), 100);
                });
                
                this.gridSize = 20;
                this.tileCountX = Math.floor(this.canvas.width / this.gridSize);
                this.tileCountY = Math.floor(this.canvas.height / this.gridSize);
                
                this.snake = [{x: Math.floor(this.tileCountX/2), y: Math.floor(this.tileCountY/2)}];
                this.food = this.generateFood();
                this.direction = {x: 0, y: 0};
                this.nextDirection = {x: 0, y: 0};
                this.score = 0;
                this.highScore = parseInt(localStorage.getItem('snakeHighScore')) || 0;
                this.gameRunning = false;
                this.gamePaused = false;
                this.gameSpeed = 150;
                this.gameLoop = null;
                
                // æ·»åŠ é˜²æŠ–æœºåˆ¶
                this.lastDirectionChange = 0;
                this.directionChangeCooldown = 50; // 50mså†·å´æ—¶é—´
                
                this.initControls();
                this.updateDisplay();
                this.draw();
                
                // é˜²æ­¢é¡µé¢æ»šåŠ¨
                document.addEventListener('touchmove', (e) => e.preventDefault(), {passive: false});
            }
            
            resizeCanvas() {
                const container = document.querySelector('.game-container');
                
                // åŠ¨æ€è®¡ç®—æœ€å¤§å®½åº¦å’Œé«˜åº¦ï¼Œé€‚åº”ä¸åŒå±å¹•
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // é’ˆå¯¹ä¸åŒæ–¹å‘è®¾ç½®ä¸åŒçš„æ¯”ä¾‹
                let maxWidth, maxHeight;
                if (window.innerWidth > window.innerHeight) {
                    // æ¨ªå‘æ¨¡å¼
                    maxWidth = Math.min(screenWidth * 0.8, screenHeight * 0.8);
                    maxHeight = Math.min(screenHeight * 0.8, screenWidth * 0.8);
                } else {
                    // çºµå‘æ¨¡å¼
                    maxWidth = Math.min(screenWidth - 20, screenHeight * 0.75);
                    maxHeight = Math.min(screenHeight * 0.75, screenWidth - 20);
                }
                
                // å–æ¶ˆ400pxçš„ç¡¬é™åˆ¶ï¼Œè®©æ¸¸æˆåŒºåŸŸæ›´å¤§
                // ä¿æŒæ­£æ–¹å½¢æ¯”ä¾‹
                const size = Math.min(maxWidth, maxHeight);
                this.canvas.width = size;
                this.canvas.height = size;
                
                if (this.gridSize) {
                    this.tileCountX = Math.floor(this.canvas.width / this.gridSize);
                    this.tileCountY = Math.floor(this.canvas.height / this.gridSize);
                }
            }
            
            initControls() {
                // å¼€å§‹æŒ‰é’®
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startGame();
                });
                
                // é‡ç½®æŒ‰é’®
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetGame();
                });
                
                // æµ‹è¯•æ–¹å‘æŒ‰é’®
                document.getElementById('testBtn').addEventListener('click', () => {
                    this.testDirections();
                });
                
                // æš‚åœæŒ‰é’®
                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.togglePause();
                });
                
                // é‡æ–°å¼€å§‹æŒ‰é’®
                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.hideGameOver();
                    this.resetGame();
                    this.startGame();
                });
                
                // æ–¹å‘æ§åˆ¶æŒ‰é’® - å¢å¼ºç‰ˆäº‹ä»¶ç»‘å®š
                const bindDirectionButton = (btn, direction) => {
                    // ç¡®ä¿æŒ‰é’®å­˜åœ¨
                    if (!btn) {
                        console.error(`æ–¹å‘æŒ‰é’® ${direction} ä¸å­˜åœ¨`);
                        return;
                    }
                    
                                    // ç»Ÿä¸€çš„æ–¹å‘è®¾ç½®å‡½æ•°
                const handleDirection = () => {
                    console.log(`è®¾ç½®æ–¹å‘: ${direction}`);
                    this.setDirection(direction);
                    
                    // å¢å¼ºçš„è§†è§‰åé¦ˆ
                    btn.style.background = 'rgba(255, 215, 0, 0.7)';
                    btn.style.transform = 'scale(1.1)';
                    btn.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.8)';
                    
                    // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                    this.vibrateDirectionButton(direction);
                    
                    setTimeout(() => {
                        btn.style.background = 'rgba(255, 255, 255, 0.2)';
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = 'none';
                    }, 150);
                    
                    // æ›´æ–°æ‰€æœ‰æ–¹å‘æŒ‰é’®çš„çŠ¶æ€
                    this.updateDirectionButtonsState();
                };
                    
                    // è§¦æ‘¸äº‹ä»¶
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        handleDirection();
                    }, {passive: false});
                    
                    // ç‚¹å‡»äº‹ä»¶
                    btn.addEventListener('click', (e) => {
                        e.preventDefault();
                        handleDirection();
                    });
                    
                    // é˜²æ­¢è¯¯è§¦
                    btn.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                    }, {passive: false});
                };
                
                // æ˜¾å¼ç»‘å®šæ¯ä¸ªæ–¹å‘æŒ‰é’®
                bindDirectionButton(document.querySelector('.direction-btn.up'), 'up');
                bindDirectionButton(document.querySelector('.direction-btn.down'), 'down');
                bindDirectionButton(document.querySelector('.direction-btn.left'), 'left');
                bindDirectionButton(document.querySelector('.direction-btn.right'), 'right');
                
                // é€Ÿåº¦é€‰æ‹©
                document.getElementById('speedSelect').addEventListener('change', (e) => {
                    this.gameSpeed = parseInt(e.target.value);
                });
                
                // æŒ¯åŠ¨å¼€å…³
                const vibrationToggle = document.getElementById('vibrationToggle');
                if (vibrationToggle) {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æŒ¯åŠ¨åå¥½
                    const savedVibration = localStorage.getItem('snakeVibrationEnabled');
                    if (savedVibration !== null) {
                        vibrationToggle.checked = savedVibration === 'true';
                    }
                    
                    // ç›‘å¬æŒ¯åŠ¨å¼€å…³å˜åŒ–
                    vibrationToggle.addEventListener('change', (e) => {
                        const enabled = e.target.checked;
                        localStorage.setItem('snakeVibrationEnabled', enabled);
                        console.log(`æŒ¯åŠ¨åé¦ˆ: ${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                        
                        // å¦‚æœå¯ç”¨æŒ¯åŠ¨ï¼Œç»™ä¸€ä¸ªæµ‹è¯•æŒ¯åŠ¨
                        if (enabled && navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    });
                }
                
                // é”®ç›˜æ§åˆ¶
                document.addEventListener('keydown', (e) => {
                    this.handleKeyPress(e);
                });
                
                // è§¦æ‘¸æ»‘åŠ¨æ§åˆ¶ - ä¼˜åŒ–ç‰ˆ
                this.initTouchControls();
            }
            
            initTouchControls() {
                let startX, startY, touchTime;
                
                // ä¼˜åŒ–è§¦æ‘¸å¼€å§‹äº‹ä»¶å¤„ç†
                this.canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) return; // å¿½ç•¥å¤šç‚¹è§¦æ‘¸
                    
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    touchTime = Date.now();
                    console.log(`è§¦æ‘¸å¼€å§‹: X=${startX}, Y=${startY}`);
                }, {passive: false});
                
                // ä¼˜åŒ–è§¦æ‘¸ç§»åŠ¨äº‹ä»¶å¤„ç†
                this.canvas.addEventListener('touchmove', (e) => {
                    if (e.touches.length > 1) return;
                    e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
                }, {passive: false});
                
                // ä¼˜åŒ–è§¦æ‘¸ç»“æŸäº‹ä»¶å¤„ç†
                this.canvas.addEventListener('touchend', (e) => {
                    if (!startX || !startY) return;
                    if (e.changedTouches.length > 1) return;
                    
                    const touch = e.changedTouches[0];
                    const deltaX = touch.clientX - startX;
                    const deltaY = touch.clientY - startY;
                    const touchDuration = Date.now() - touchTime;
                    
                    const absDeltaX = Math.abs(deltaX);
                    const absDeltaY = Math.abs(deltaY);
                    
                    // é’ˆå¯¹å°ç±³13 ultraä¼˜åŒ–æ»‘åŠ¨è¯†åˆ«
                    // é™ä½æœ€å°æ»‘åŠ¨è·ç¦»é˜ˆå€¼ï¼Œæé«˜çµæ•åº¦
                    let minSwipeDistance;
                    if (touchDuration < 100) {
                        // æå¿«é€Ÿè§¦æ‘¸ï¼Œè¿›ä¸€æ­¥é™ä½é˜ˆå€¼
                        minSwipeDistance = Math.max(10, window.innerWidth * 0.02);
                    } else if (touchDuration < 200) {
                        // å¿«é€Ÿè§¦æ‘¸
                        minSwipeDistance = Math.max(15, window.innerWidth * 0.03);
                    } else {
                        // æ­£å¸¸è§¦æ‘¸
                        minSwipeDistance = Math.max(20, window.innerWidth * 0.04);
                    }
                    
                    console.log(`è§¦æ‘¸ç»“æŸ: æ»‘åŠ¨è·ç¦»X=${deltaX}, Y=${deltaY}, æ—¶é—´=${touchDuration}ms, æœ€å°é˜ˆå€¼=${minSwipeDistance}`);
                    
                    if (Math.max(absDeltaX, absDeltaY) < minSwipeDistance) {
                        // è§¦æ‘¸ç‚¹å¤ªè¿‘ï¼Œå¯èƒ½æ˜¯ç‚¹å‡»è€Œéæ»‘åŠ¨
                        console.log(`æ»‘åŠ¨è·ç¦»ä¸è¶³ï¼Œå¿½ç•¥: ${Math.max(absDeltaX, absDeltaY)} < ${minSwipeDistance}`);
                        startX = null;
                        startY = null;
                        return;
                    }
                    
                    // ç¡®å®šæ»‘åŠ¨æ–¹å‘
                    if (absDeltaX > absDeltaY) {
                        // æ°´å¹³æ»‘åŠ¨
                        if (deltaX > 0) {
                            console.log('è¯†åˆ«åˆ°å‘å³æ»‘åŠ¨');
                            this.setDirection('right');
                            // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                            this.vibrateDirectionButton('right');
                        } else {
                            console.log('è¯†åˆ«åˆ°å‘å·¦æ»‘åŠ¨');
                            this.setDirection('left');
                            // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                            this.vibrateDirectionButton('left');
                        }
                    } else {
                        // å‚ç›´æ»‘åŠ¨
                        if (deltaY > 0) {
                            console.log('è¯†åˆ«åˆ°å‘ä¸‹æ»‘åŠ¨');
                            this.setDirection('down');
                            // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                            this.vibrateDirectionButton('down');
                        } else {
                            console.log('è¯†åˆ«åˆ°å‘ä¸Šæ»‘åŠ¨');
                            this.setDirection('up');
                            // æ·»åŠ æŒ¯åŠ¨åé¦ˆ
                            this.vibrateDirectionButton('up');
                        }
                    }
                    
                    startX = null;
                    startY = null;
                }, {passive: false});
            }
            
            handleKeyPress(e) {
                switch(e.key) {
                    case 'ArrowUp':
                        this.setDirection('up');
                        this.vibrateDirectionButton('up');
                        break;
                    case 'ArrowDown':
                        this.setDirection('down');
                        this.vibrateDirectionButton('down');
                        break;
                    case 'ArrowLeft':
                        this.setDirection('left');
                        this.vibrateDirectionButton('left');
                        break;
                    case 'ArrowRight':
                        this.setDirection('right');
                        this.vibrateDirectionButton('right');
                        break;
                    case ' ':
                        this.togglePause();
                        break;
                }
            }
            
            setDirection(dir) {
                // ç¡®ä¿æ–¹å‘æœ‰æ•ˆ
                const validDirections = ['up', 'down', 'left', 'right'];
                if (!validDirections.includes(dir)) {
                    console.log(`æ— æ•ˆçš„æ–¹å‘: ${dir}`);
                    return;
                }
                
                // å®šä¹‰æ–¹å‘æ˜ å°„ï¼ˆç§»åˆ°å‰é¢ï¼‰
                const directions = {
                    'up': {x: 0, y: -1},
                    'down': {x: 0, y: 1},
                    'left': {x: -1, y: 0},
                    'right': {x: 1, y: 0}
                };
                
                // æ¸¸æˆæœªè¿è¡Œæ—¶ä¹Ÿå…è®¸è®¾ç½®æ–¹å‘ï¼Œä»¥ä¾¿æ¸¸æˆå¼€å§‹æ—¶ä½¿ç”¨
                if (this.gamePaused) {
                    console.log('æ¸¸æˆå·²æš‚åœï¼Œå¿½ç•¥æ–¹å‘è¾“å…¥');
                    return;
                }
                
                // é˜²æŠ–æ£€æŸ¥ - é˜²æ­¢å¿«é€Ÿè¿ç»­æŒ‰é”®
                const now = Date.now();
                if (now - this.lastDirectionChange < this.directionChangeCooldown) {
                    console.log(`æ–¹å‘å˜åŒ–è¿‡å¿«ï¼Œå¿½ç•¥: ${dir} (å†·å´ä¸­)`);
                    return;
                }
                this.lastDirectionChange = now;
                
                // é¢å¤–ä¿æŠ¤ï¼šé˜²æ­¢åœ¨å¾—åˆ†åç«‹å³åå‘ç§»åŠ¨
                if (this.snake.length > 1) {
                    const currentDir = this.direction;
                    const newDir = directions[dir];
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºåå‘ç§»åŠ¨
                    if ((currentDir.x === 1 && newDir.x === -1) || // å³â†’å·¦
                        (currentDir.x === -1 && newDir.x === 1) || // å·¦â†’å³
                        (currentDir.y === 1 && newDir.y === -1) || // ä¸‹â†’ä¸Š
                        (currentDir.y === -1 && newDir.y === 1)) { // ä¸Šâ†’ä¸‹
                        
                        console.log(`é˜»æ­¢åå‘ç§»åŠ¨: å½“å‰æ–¹å‘(${currentDir.x}, ${currentDir.y}) â†’ æ–°æ–¹å‘(${newDir.x}, ${newDir.y})`);
                        return;
                    }
                }
                
                const newDirection = directions[dir];
                
                // å¦‚æœæ¸¸æˆåˆšå¼€å§‹ï¼Œè›‡è¿˜æ²¡æœ‰æ–¹å‘ï¼Œå…è®¸ä»»ä½•æ–¹å‘
                if (this.direction.x === 0 && this.direction.y === 0) {
                    console.log(`è®¾ç½®åˆå§‹æ–¹å‘: ${dir}`);
                    this.nextDirection = newDirection;
                    this.direction = newDirection; // ç«‹å³è®¾ç½®å½“å‰æ–¹å‘
                    
                    // å¦‚æœæ¸¸æˆæœªè¿è¡Œï¼Œå¯åŠ¨æ¸¸æˆ
                    if (!this.gameRunning) {
                        this.startGame();
                    }
                    return;
                }
                
                // ä¼˜åŒ–æ–¹å‘æ§åˆ¶é€»è¾‘ - å®ç°ç”¨æˆ·éœ€æ±‚
                const currentDirName = this.getDirectionName(this.direction);
                const newDirName = dir;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºä¿æŒå½“å‰æ–¹å‘ï¼ˆæ— æ•ˆæ“ä½œï¼‰
                let isSameDirection = false;
                
                if (currentDirName === 'ä¸Š' && newDirName === 'up') {
                    isSameDirection = true;
                } else if (currentDirName === 'ä¸‹' && newDirName === 'down') {
                    isSameDirection = true;
                } else if (currentDirName === 'å·¦' && newDirName === 'left') {
                    isSameDirection = true;
                } else if (currentDirName === 'å³' && newDirName === 'right') {
                    isSameDirection = true;
                }
                
                if (isSameDirection) {
                    console.log(`å¿½ç•¥ç›¸åŒæ–¹å‘: å½“å‰æ–¹å‘ ${currentDirName}ï¼Œå°è¯•ä¿æŒ ${newDirName}`);
                    return;
                }
                
                // æ–¹å‘æœ‰æ•ˆï¼Œè®¾ç½®åˆ°nextDirectionç­‰å¾…ä¸‹ä¸€å¸§æ›´æ–°
                this.nextDirection = newDirection;
                console.log(`æ–¹å‘è®¾ç½®æˆåŠŸ: ä» ${currentDirName} è½¬å‘ ${newDirName}`);
            }
            
            // è¾…åŠ©æ–¹æ³•ï¼šè·å–æ–¹å‘åç§°
            getDirectionName(direction) {
                if (direction.x === 1) return 'å³';
                if (direction.x === -1) return 'å·¦';
                if (direction.y === 1) return 'ä¸‹';
                if (direction.y === -1) return 'ä¸Š';
                return 'æ— ';
            }
            
            // æ›´æ–°æ–¹å‘æŒ‰é’®çŠ¶æ€ï¼Œæ˜¾ç¤ºå½“å‰æ–¹å‘
            updateDirectionButtonsState() {
                const currentDir = this.getDirectionName(this.direction);
                
                // é‡ç½®æ‰€æœ‰æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.direction-btn').forEach(btn => {
                    btn.style.background = 'rgba(255, 255, 255, 0.2)';
                    btn.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                    btn.style.color = 'white';
                });
                
                // é«˜äº®å½“å‰æ–¹å‘æŒ‰é’®
                let currentBtn = null;
                if (currentDir === 'ä¸Š') {
                    currentBtn = document.querySelector('.direction-btn.up');
                } else if (currentDir === 'ä¸‹') {
                    currentBtn = document.querySelector('.direction-btn.down');
                } else if (currentDir === 'å·¦') {
                    currentBtn = document.querySelector('.direction-btn.left');
                } else if (currentDir === 'å³') {
                    currentBtn = document.querySelector('.direction-btn.right');
                }
                
                if (currentBtn) {
                    currentBtn.style.background = 'rgba(255, 215, 0, 0.3)';
                    currentBtn.style.border = '2px solid #FFD700';
                    currentBtn.style.color = '#FFD700';
                }
            }
            
            startGame() {
                if (this.gameRunning) return;
                
                this.gameRunning = true;
                this.gamePaused = false;
                
                // å¦‚æœè›‡è¿˜æ²¡æœ‰æ–¹å‘ï¼Œç»™ä¸€ä¸ªé»˜è®¤æ–¹å‘ï¼ˆå‘å³ï¼‰
                if (this.direction.x === 0 && this.direction.y === 0) {
                    this.direction = {x: 1, y: 0};
                    this.nextDirection = {x: 1, y: 0};
                }
                
                document.getElementById('startBtn').textContent = 'æ¸¸æˆä¸­...';
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').textContent = 'æš‚åœ';
                
                this.runGameLoop();
            }
            
            runGameLoop() {
                if (!this.gameRunning || this.gamePaused) return;
                
                this.update();
                this.draw();
                this.updateDisplay();
                
                this.gameLoop = setTimeout(() => this.runGameLoop(), this.gameSpeed);
            }
            
            update() {
                // æ”¹è¿›çš„æ–¹å‘æ›´æ–°é€»è¾‘ - åªåœ¨å®é™…æ”¹å˜æ–¹å‘æ—¶æ‰é‡ç½®nextDirection
                if (this.nextDirection.x !== 0 || this.nextDirection.y !== 0) {
                    // æ£€æŸ¥æ–°æ–¹å‘æ˜¯å¦ä¸å½“å‰æ–¹å‘ä¸åŒ
                    if (this.direction.x !== this.nextDirection.x || this.direction.y !== this.nextDirection.y) {
                        this.direction = {...this.nextDirection};
                        console.log(`æ–¹å‘å·²æ›´æ–°: (${this.direction.x}, ${this.direction.y})`);
                    }
                    // åªæœ‰åœ¨åº”ç”¨äº†æ–¹å‘å˜åŒ–åæ‰é‡ç½®nextDirection
                    this.nextDirection = {x: 0, y: 0};
                }
                
                if (this.direction.x === 0 && this.direction.y === 0) return;
                
                // ç§»åŠ¨è›‡å¤´
                const head = {
                    x: this.snake[0].x + this.direction.x,
                    y: this.snake[0].y + this.direction.y
                };
                
                // å®ç°ç©¿å¢™æ•ˆæœ - è›‡å¯ä»¥ç©¿è¿‡è¾¹ç•Œä»å¯¹é¢æ»‘å‡º
                if (head.x < 0) {
                    head.x = this.tileCountX - 1; // ä»å³è¾¹æ»‘å‡º
                    console.log(`ç©¿å¢™: ä»å·¦è¾¹ç©¿å‡ºï¼Œåœ¨å³è¾¹å‡ºç° x=${head.x}, y=${head.y}`);
                } else if (head.x >= this.tileCountX) {
                    head.x = 0; // ä»å·¦è¾¹æ»‘å‡º
                    console.log(`ç©¿å¢™: ä»å³è¾¹ç©¿å‡ºï¼Œåœ¨å·¦è¾¹å‡ºç° x=${head.x}, y=${head.y}`);
                }
                
                if (head.y < 0) {
                    head.y = this.tileCountY - 1; // ä»ä¸‹è¾¹æ»‘å‡º
                    console.log(`ç©¿å¢™: ä»ä¸Šè¾¹ç©¿å‡ºï¼Œåœ¨ä¸‹è¾¹å‡ºç° x=${head.x}, y=${head.y}`);
                } else if (head.y >= this.tileCountY) {
                    head.y = 0; // ä»ä¸Šè¾¹æ»‘å‡º
                    console.log(`ç©¿å¢™: ä»ä¸Šè¾¹ç©¿å‡ºï¼Œåœ¨ä¸Šè¾¹å‡ºç° x=${head.x}, y=${head.y}`);
                }
                
                // å…ˆæ·»åŠ è›‡å¤´
                this.snake.unshift(head);
                
                // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.score += 10;
                    this.food = this.generateFood();
                    
                    // æ’­æ”¾åƒé£Ÿç‰©éŸ³æ•ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
                    this.playEatSound();
                } else {
                    // å¦‚æœæ²¡åƒåˆ°é£Ÿç‰©ï¼Œåˆ é™¤å°¾éƒ¨
                    this.snake.pop();
                }
                
                // æ£€æŸ¥è‡ªèº«ç¢°æ’ - åœ¨è›‡å¤´æ·»åŠ åæ£€æŸ¥
                const collisionSegment = this.snake.find((segment, index) => {
                    // è·³è¿‡è›‡å¤´ï¼ˆindex === 0ï¼‰ï¼Œåªæ£€æŸ¥ä¸è›‡èº«çš„ç¢°æ’
                    return index > 0 && segment.x === head.x && segment.y === head.y;
                });
                
                if (collisionSegment) {
                    console.log(`ğŸš¨ è‡ªèº«ç¢°æ’æ£€æµ‹è§¦å‘ï¼`);
                    console.log(`è›‡å¤´ä½ç½®: (${head.x}, ${head.y})`);
                    console.log(`ç¢°æ’æ®µä½ç½®: (${collisionSegment.x}, ${collisionSegment.y})`);
                    console.log(`è›‡èº«é•¿åº¦: ${this.snake.length}`);
                    console.log(`å½“å‰æ–¹å‘: (${this.direction.x}, ${this.direction.y})`);
                    console.log(`è›‡èº«æ•°ç»„:`, this.snake.map((seg, i) => `[${i}]:(${seg.x},${seg.y})`));
                    console.log(`é£Ÿç‰©ä½ç½®: (${this.food.x}, ${this.food.y})`);
                    this.gameOver();
                    return;
                }
            }
            
            generateFood() {
                let newFood;
                do {
                    newFood = {
                        x: Math.floor(Math.random() * this.tileCountX),
                        y: Math.floor(Math.random() * this.tileCountY)
                    };
                } while (this.snake.some(segment => segment.x === newFood.x && segment.y === newFood.y));
                
                return newFood;
            }
            
            draw() {
                // æ¸…ç©ºç”»å¸ƒ
                this.ctx.fillStyle = '#000';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ç»˜åˆ¶ç½‘æ ¼ï¼ˆå¯é€‰ï¼‰
                this.drawGrid();
                
                // ç»˜åˆ¶é£Ÿç‰©
                this.drawFood();
                
                // ç»˜åˆ¶è›‡
                this.drawSnake();
            }
            
            drawGrid() {
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                
                for (let x = 0; x <= this.tileCountX; x++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x * this.gridSize, 0);
                    this.ctx.lineTo(x * this.gridSize, this.canvas.height);
                    this.ctx.stroke();
                }
                
                for (let y = 0; y <= this.tileCountY; y++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y * this.gridSize);
                    this.ctx.lineTo(this.canvas.width, y * this.gridSize);
                    this.ctx.stroke();
                }
            }
            
            drawSnake() {
                this.snake.forEach((segment, index) => {
                    if (index === 0) {
                        // è›‡å¤´
                        this.ctx.fillStyle = '#FFD700';
                    } else {
                        // è›‡èº«
                        this.ctx.fillStyle = '#32CD32';
                    }
                    
                    this.ctx.fillRect(
                        segment.x * this.gridSize + 1,
                        segment.y * this.gridSize + 1,
                        this.gridSize - 2,
                        this.gridSize - 2
                    );
                    
                    // è›‡å¤´çœ¼ç›
                    if (index === 0) {
                        this.ctx.fillStyle = '#000';
                        const eyeSize = Math.max(2, this.gridSize / 8);
                        const eyeOffset = Math.max(3, this.gridSize / 6);
                        
                        this.ctx.fillRect(
                            segment.x * this.gridSize + eyeOffset,
                            segment.y * this.gridSize + eyeOffset,
                            eyeSize, eyeSize
                        );
                        this.ctx.fillRect(
                            segment.x * this.gridSize + this.gridSize - eyeOffset - eyeSize,
                            segment.y * this.gridSize + eyeOffset,
                            eyeSize, eyeSize
                        );
                    }
                });
            }
            
            drawFood() {
                this.ctx.fillStyle = '#FF4444';
                this.ctx.fillRect(
                    this.food.x * this.gridSize + 2,
                    this.food.y * this.gridSize + 2,
                    this.gridSize - 4,
                    this.gridSize - 4
                );
                
                // é£Ÿç‰©å…‰æ³½
                this.ctx.fillStyle = '#FF8888';
                this.ctx.fillRect(
                    this.food.x * this.gridSize + 3,
                    this.food.y * this.gridSize + 3,
                    Math.max(1, this.gridSize / 4),
                    Math.max(1, this.gridSize / 4)
                );
            }
            
            gameOver() {
                this.gameRunning = false;
                
                if (this.gameLoop) {
                    clearTimeout(this.gameLoop);
                    this.gameLoop = null;
                }
                
                // æ£€æŸ¥æ˜¯å¦åˆ›é€ æ–°çºªå½•
                const isNewRecord = this.score > this.highScore;
                if (isNewRecord) {
                    this.highScore = this.score;
                    localStorage.setItem('snakeHighScore', this.highScore);
                }
                
                this.showGameOver(isNewRecord);
                this.updateDisplay();
                
                // æ’­æ”¾æ¸¸æˆç»“æŸéŸ³æ•ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
                this.playGameOverSound();
            }
            
            showGameOver(isNewRecord) {
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalLength').textContent = this.snake.length;
                
                const recordMessage = document.getElementById('recordMessage');
                if (isNewRecord && this.score > 0) {
                    recordMessage.style.display = 'block';
                } else {
                    recordMessage.style.display = 'none';
                }
                
                document.getElementById('gameOverOverlay').style.display = 'flex';
            }
            
            hideGameOver() {
                document.getElementById('gameOverOverlay').style.display = 'none';
            }
            
            resetGame() {
                this.gameRunning = false;
                this.gamePaused = false;
                
                if (this.gameLoop) {
                    clearTimeout(this.gameLoop);
                    this.gameLoop = null;
                }
                
                this.snake = [{x: Math.floor(this.tileCountX/2), y: Math.floor(this.tileCountY/2)}];
                this.food = this.generateFood();
                this.direction = {x: 0, y: 0};
                this.nextDirection = {x: 0, y: 0};
                this.score = 0;
                
                document.getElementById('startBtn').textContent = 'å¼€å§‹æ¸¸æˆ';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').textContent = 'æš‚åœ';
                
                this.hideGameOver();
                this.updateDisplay();
                this.draw();
            }
            
            togglePause() {
                if (!this.gameRunning) return;
                
                this.gamePaused = !this.gamePaused;
                document.getElementById('pauseBtn').textContent = this.gamePaused ? 'ç»§ç»­' : 'æš‚åœ';
                
                if (!this.gamePaused) {
                    this.runGameLoop();
                }
            }
            
            updateDisplay() {
                document.getElementById('currentScore').textContent = this.score;
                document.getElementById('highScore').textContent = this.highScore;
                document.getElementById('snakeLength').textContent = this.snake.length;
                
                // æ›´æ–°æ–¹å‘æŒ‰é’®çŠ¶æ€
                this.updateDirectionButtonsState();
            }
            
            // æµ‹è¯•æ–¹å‘åŠŸèƒ½
            testDirections() {
                alert('æ–¹å‘æµ‹è¯•å¼€å§‹ï¼\nè¯·æŒ‰é¡ºåºç‚¹å‡»ï¼šä¸Šâ†’å³â†’ä¸‹â†’å·¦\nè§‚å¯Ÿè›‡çš„ç§»åŠ¨æ˜¯å¦æ­£ç¡®');
                this.resetGame();
                this.startGame();
                
                // å¼ºåˆ¶è®¾ç½®ä¸ºå‘ä¸Šï¼Œå¼€å§‹æµ‹è¯•
                setTimeout(() => {
                    this.setDirection('up');
                    console.log('æµ‹è¯•ï¼šè®¾ç½®å‘ä¸Š');
                }, 500);
            }
            
            // æ–¹å‘æŒ‰é’®æŒ¯åŠ¨åé¦ˆæ–¹æ³•
            vibrateDirectionButton(direction) {
                // æ£€æŸ¥æŒ¯åŠ¨å¼€å…³çŠ¶æ€
                const vibrationToggle = document.getElementById('vibrationToggle');
                if (!vibrationToggle || !vibrationToggle.checked) {
                    return; // æŒ¯åŠ¨åŠŸèƒ½è¢«ç¦ç”¨
                }
                
                if (!navigator.vibrate) {
                    console.log('è®¾å¤‡ä¸æ”¯æŒæŒ¯åŠ¨åŠŸèƒ½');
                    return;
                }
                
                // æ ¹æ®ä¸åŒæ–¹å‘è®¾ç½®ä¸åŒçš„æŒ¯åŠ¨æ¨¡å¼
                let vibrationPattern;
                switch (direction) {
                    case 'up':
                        vibrationPattern = [30, 20, 30]; // ä¸Šï¼šçŸ­-çŸ­-çŸ­
                        break;
                    case 'down':
                        vibrationPattern = [50, 30, 50]; // ä¸‹ï¼šé•¿-çŸ­-é•¿
                        break;
                    case 'left':
                        vibrationPattern = [40, 40]; // å·¦ï¼šä¸­-ä¸­
                        break;
                    case 'right':
                        vibrationPattern = [60, 20, 60]; // å³ï¼šé•¿-çŸ­-é•¿
                        break;
                    default:
                        vibrationPattern = [30]; // é»˜è®¤çŸ­æŒ¯åŠ¨
                }
                
                try {
                    navigator.vibrate(vibrationPattern);
                    console.log(`æŒ¯åŠ¨åé¦ˆ: ${direction}, æ¨¡å¼: [${vibrationPattern.join(', ')}]`);
                } catch (error) {
                    console.warn('æŒ¯åŠ¨åé¦ˆå¤±è´¥:', error);
                }
            }
            
            // éŸ³æ•ˆæ–¹æ³•ï¼ˆå ä½ç¬¦ï¼Œå¯ä»¥æ·»åŠ Web Audio APIå®ç°ï¼‰
            playEatSound() {
                // å¯ä»¥æ·»åŠ éŸ³æ•ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(50); // éœ‡åŠ¨åé¦ˆ
                }
            }
            
            playGameOverSound() {
                // å¯ä»¥æ·»åŠ éŸ³æ•ˆ
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]); // éœ‡åŠ¨åé¦ˆ
                }
            }
        }
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ¸¸æˆ...');
                const game = new AndroidSnakeGame();
                console.log('æ¸¸æˆåˆå§‹åŒ–æˆåŠŸ');
                
                // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
                window.addEventListener('error', (e) => {
                    console.error('æ¸¸æˆè¿è¡Œé”™è¯¯:', e.error);
                });
                
                // æ·»åŠ è§¦æ‘¸äº‹ä»¶è°ƒè¯•
                document.addEventListener('touchstart', (e) => {
                    console.log('å…¨å±€è§¦æ‘¸å¼€å§‹äº‹ä»¶:', e.touches.length, 'ä¸ªè§¦æ‘¸ç‚¹');
                });
                
            } catch (error) {
                console.error('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:', error);
                alert('æ¸¸æˆåˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });
        
        // é˜²æ­¢é¡µé¢ç¼©æ”¾
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        document.addEventListener('gesturechange', (e) => e.preventDefault());
    </script>
</body>
</html>